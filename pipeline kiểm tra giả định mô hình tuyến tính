data1 <- #dá»¯ liá»‡u long data tá»« excel, csv  . .

if (!require("pacman", quietly = TRUE)) install.packages("pacman")   #update ngáº¯n gá»n hÆ¡n ban Ä‘áº§u
pacman::p_load(ggplot2, lmtest, car, gridExtra, tidyr, quietly = TRUE)

setup_regression_packages()

check_regression_assumptions <- function(data, 
                                         independent_vars,
                                         dependent_vars,
                                         output_dir = "regression_results",
                                         save_plots = TRUE) {
  
  cat("â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—\n")
  cat("â•‘     KIá»‚M TRA GIáº¢ Äá»ŠNH Há»’I QUY TUYáº¾N TÃNH             â•‘\n")
  cat("â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n")
  
  # Táº¡o thÆ° má»¥c output
  if (save_plots && !dir.exists(output_dir)) {
    dir.create(output_dir, recursive = TRUE)
  }
  
  cat("ğŸ“Š Dá»¯ liá»‡u:", nrow(data), "máº«u\n")
  cat("ğŸ“ˆ Biáº¿n Ä‘á»™c láº­p:", paste(independent_vars, collapse = ", "), "\n")
  cat("ğŸ“‰ Biáº¿n phá»¥ thuá»™c:", paste(dependent_vars, collapse = ", "), "\n\n")
  
  # LÆ°u káº¿t quáº£
  all_results <- list()
  
  # Duyá»‡t qua tá»«ng cáº·p biáº¿n
  for (dep_var in dependent_vars) {
    for (indep_var in independent_vars) {
      
      cat("\n", rep("â•", 70), "\n", sep = "")
      cat("MÃ” HÃŒNH:", dep_var, "~", indep_var, "\n")
      cat(rep("â•", 70), "\n\n", sep = "")
      
      # Kiá»ƒm tra dá»¯ liá»‡u há»£p lá»‡
      valid_data <- data[complete.cases(data[[dep_var]], data[[indep_var]]), ]
      
      if (nrow(valid_data) < 10) {
        cat("âŒ KHÃ”NG Äá»¦ Dá»® LIá»†U (cáº§n Ã­t nháº¥t 10 máº«u)\n\n")
        next
      }
      
      # XÃ¢y dá»±ng mÃ´ hÃ¬nh
      formula_str <- as.formula(paste0("`", dep_var, "`", " ~ ", "`", indep_var, "`"))
      model <- lm(formula_str, data = valid_data)
      
      cat("ğŸ“Š ThÃ´ng tin mÃ´ hÃ¬nh:\n")
      cat(sprintf("   Sá»‘ máº«u: %d\n", nrow(valid_data)))
      cat(sprintf("   RÂ² = %.4f\n", summary(model)$r.squared))
      cat(sprintf("   Adjusted RÂ² = %.4f\n", summary(model)$adj.r.squared))
      cat(sprintf("   p-value = %.4e\n\n", 
                  summary(model)$coefficients[2, 4]))
      
      # Kiá»ƒm tra cÃ¡c giáº£ Ä‘á»‹nh
      results <- list(
        model = model,
        dep_var = dep_var,
        indep_var = indep_var,
        n = nrow(valid_data),
        r_squared = summary(model)$r.squared
      )
      
      # 1. Kiá»ƒm tra tuyáº¿n tÃ­nh
      results$linearity <- check_linearity(valid_data, indep_var, dep_var, 
                                           model, save_plots, output_dir)
      
      # 2. Kiá»ƒm tra Ä‘á»™c láº­p pháº§n dÆ°
      results$independence <- check_independence(model)
      
      # 3. Kiá»ƒm tra phÆ°Æ¡ng sai Ä‘á»“ng nháº¥t
      results$homoscedasticity <- check_homoscedasticity(model, indep_var, 
                                                         dep_var, save_plots, 
                                                         output_dir)
      
      # 4. Kiá»ƒm tra phÃ¢n phá»‘i chuáº©n pháº§n dÆ°
      results$normality <- check_residual_normality(model, indep_var, dep_var,
                                                    save_plots, output_dir)
      
      # Káº¿t luáº­n tá»•ng thá»ƒ
      results$overall <- overall_conclusion(results)
      
      # LÆ°u káº¿t quáº£
      model_name <- paste(dep_var, indep_var, sep = "_vs_")
      all_results[[model_name]] <- results
    }
  }
  
  # In bÃ¡o cÃ¡o tá»•ng káº¿t
  print_overall_report(all_results)
  
  cat("\nâœ… Kiá»ƒm tra hoÃ n táº¥t! Káº¿t quáº£ lÆ°u táº¡i:", output_dir, "\n\n")
  
  # ThÃªm cÃ¡c hÃ m tiá»‡n Ã­ch
  all_results$show_plot <- function(model_name, plot_type = "all") {
    show_regression_plot(all_results, model_name, plot_type)
  }
  
  all_results$show_all_plots <- function(model_name) {
    show_all_plots_for_model(all_results, model_name)
  }
  
  all_results$list_models <- function() {
    list_available_models(all_results)
  }
  
  invisible(all_results)
}

# ============================================================================
# HIá»‚N THá»Š BIá»‚U Äá»’
# ============================================================================

show_regression_plot <- function(results, model_name, plot_type = "all") {
  # Kiá»ƒm tra model tá»“n táº¡i
  if (!model_name %in% names(results)) {
    cat("âŒ KhÃ´ng tÃ¬m tháº¥y mÃ´ hÃ¬nh:", model_name, "\n")
    cat("ğŸ“‹ CÃ¡c mÃ´ hÃ¬nh cÃ³ sáºµn:\n")
    for (name in names(results)[!names(results) %in% c("show_plot", "show_all_plots", "list_models")]) {
      cat("   â€¢", name, "\n")
    }
    return(invisible(NULL))
  }
  
  model_result <- results[[model_name]]
  
  # Hiá»ƒn thá»‹ theo loáº¡i
  if (plot_type == "all") {
    show_all_plots_for_model(results, model_name)
  } else if (plot_type == "linearity" || plot_type == "1") {
    print(model_result$linearity$plot)
    cat("\nâœ“ Hiá»ƒn thá»‹: Biá»ƒu Ä‘á»“ tuyáº¿n tÃ­nh\n")
  } else if (plot_type == "homoscedasticity" || plot_type == "3") {
    print(model_result$homoscedasticity$plot)
    cat("\nâœ“ Hiá»ƒn thá»‹: Biá»ƒu Ä‘á»“ phÆ°Æ¡ng sai Ä‘á»“ng nháº¥t\n")
  } else if (plot_type == "normality" || plot_type == "4") {
    print(model_result$normality$plot)
    cat("\nâœ“ Hiá»ƒn thá»‹: Q-Q Plot\n")
  } else {
    cat("âŒ Loáº¡i biá»ƒu Ä‘á»“ khÃ´ng há»£p lá»‡!\n")
    cat("ğŸ“‹ CÃ¡c loáº¡i há»£p lá»‡: 'linearity', 'homoscedasticity', 'normality', 'all'\n")
  }
}

show_all_plots_for_model <- function(results, model_name) {
  if (!model_name %in% names(results)) {
    cat("âŒ KhÃ´ng tÃ¬m tháº¥y mÃ´ hÃ¬nh:", model_name, "\n")
    return(invisible(NULL))
  }
  
  model_result <- results[[model_name]]
  
  cat("\nâ•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—\n")
  cat("â•‘         BIá»‚U Äá»’ KIá»‚M TRA GIáº¢ Äá»ŠNH Há»’I QUY            â•‘\n")
  cat("â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n")
  cat("MÃ´ hÃ¬nh:", model_result$dep_var, "~", model_result$indep_var, "\n\n")
  
  # Táº¡o layout 2x2 Ä‘á»ƒ hiá»ƒn thá»‹ táº¥t cáº£ biá»ƒu Ä‘á»“
  gridExtra::grid.arrange(
    model_result$linearity$plot + 
      labs(title = "1. Tuyáº¿n tÃ­nh") +
      theme(plot.title = element_text(size = 10, face = "bold")),
    
    ggplot() + 
      annotate("text", x = 0.5, y = 0.5, 
               label = "Durbin-Watson Test\n(KhÃ´ng cÃ³ biá»ƒu Ä‘á»“)", 
               size = 5) +
      theme_void() +
      labs(title = "2. Äá»™c láº­p pháº§n dÆ°") +
      theme(plot.title = element_text(size = 10, face = "bold")),
    
    model_result$homoscedasticity$plot + 
      labs(title = "3. PhÆ°Æ¡ng sai Ä‘á»“ng nháº¥t") +
      theme(plot.title = element_text(size = 10, face = "bold")),
    
    model_result$normality$plot + 
      labs(title = "4. PhÃ¢n phá»‘i chuáº©n") +
      theme(plot.title = element_text(size = 10, face = "bold")),
    
    ncol = 2,
    top = paste("Kiá»ƒm tra giáº£ Ä‘á»‹nh:", model_result$dep_var, "~", model_result$indep_var)
  )
  
  cat("âœ“ Hiá»ƒn thá»‹ táº¥t cáº£ biá»ƒu Ä‘á»“\n\n")
}

list_available_models <- function(results) {
  cat("\nâ•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—\n")
  cat("â•‘              DANH SÃCH MÃ” HÃŒNH                        â•‘\n")
  cat("â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n")
  
  model_names <- names(results)[!names(results) %in% c("show_plot", "show_all_plots", "list_models")]
  
  if (length(model_names) == 0) {
    cat("KhÃ´ng cÃ³ mÃ´ hÃ¬nh nÃ o\n")
    return(invisible(NULL))
  }
  
  cat(sprintf("Tá»•ng sá»‘ mÃ´ hÃ¬nh: %d\n\n", length(model_names)))
  
  for (i in seq_along(model_names)) {
    model_name <- model_names[i]
    model_result <- results[[model_name]]
    status <- ifelse(model_result$overall$all_assumptions_met, "âœ…", "âŒ")
    
    cat(sprintf("[%d] %s\n", i, model_name))
    cat(sprintf("    %s ~ %s\n", model_result$dep_var, model_result$indep_var))
    cat(sprintf("    RÂ² = %.3f | Status: %s\n\n", 
                model_result$r_squared, status))
  }
  
  cat("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n")
  cat("ğŸ’¡ CÃ¡ch hiá»ƒn thá»‹ biá»ƒu Ä‘á»“:\n")
  cat("   results$show_plot('model_name', 'linearity')\n")
  cat("   results$show_all_plots('model_name')\n\n")
}

# ============================================================================
# HÃ€M Táº O BIá»‚U Äá»’ Tá»”NG Há»¢P
# ============================================================================

create_summary_plots <- function(results, output_file = "all_models_summary.png") {
  model_names <- names(results)[!names(results) %in% c("show_plot", "show_all_plots", "list_models")]
  
  if (length(model_names) == 0) {
    cat("KhÃ´ng cÃ³ mÃ´ hÃ¬nh nÃ o Ä‘á»ƒ váº½\n")
    return(invisible(NULL))
  }
  
  cat("\nğŸ“Š Táº¡o biá»ƒu Ä‘á»“ tá»•ng há»£p cho", length(model_names), "mÃ´ hÃ¬nh...\n")
  
  # Táº¡o dataframe cho biá»ƒu Ä‘á»“
  summary_data <- data.frame()
  
  for (model_name in model_names) {
    model_result <- results[[model_name]]
    summary_data <- rbind(summary_data, data.frame(
      Model = paste(model_result$dep_var, "~", model_result$indep_var),
      R_squared = model_result$r_squared,
      Linearity = ifelse(model_result$linearity$pass, 1, 0),
      Independence = ifelse(model_result$independence$pass, 1, 0),
      Homoscedasticity = ifelse(model_result$homoscedasticity$pass, 1, 0),
      Normality = ifelse(model_result$normality$pass, 1, 0),
      Overall = ifelse(model_result$overall$all_assumptions_met, "Pass", "Fail")
    ))
  }
  
  # Biá»ƒu Ä‘á»“ RÂ²
  p1 <- ggplot(summary_data, aes(x = reorder(Model, R_squared), y = R_squared, fill = Overall)) +
    geom_bar(stat = "identity") +
    coord_flip() +
    scale_fill_manual(values = c("Pass" = "green3", "Fail" = "red3")) +
    labs(title = "RÂ² cá»§a cÃ¡c mÃ´ hÃ¬nh", x = "", y = "RÂ²") +
    theme_minimal() +
    theme(legend.position = "bottom")
  
  # Biá»ƒu Ä‘á»“ giáº£ Ä‘á»‹nh
  assumptions_long <- summary_data %>%
    select(Model, Linearity, Independence, Homoscedasticity, Normality) %>%
    pivot_longer(cols = -Model, names_to = "Assumption", values_to = "Pass")
  
  p2 <- ggplot(assumptions_long, aes(x = Model, y = Assumption, fill = factor(Pass))) +
    geom_tile(color = "white") +
    scale_fill_manual(values = c("0" = "red3", "1" = "green3"), 
                      labels = c("Vi pháº¡m", "Äáº¡t"),
                      name = "") +
    labs(title = "Ma tráº­n giáº£ Ä‘á»‹nh", x = "", y = "") +
    theme_minimal() +
    theme(axis.text.x = element_text(angle = 45, hjust = 1),
          legend.position = "bottom")
  
  # Káº¿t há»£p vÃ  lÆ°u
  combined <- gridExtra::grid.arrange(p1, p2, ncol = 1)
  
  ggsave(output_file, combined, width = 10, height = 8, dpi = 300)
  cat("âœ“ ÄÃ£ lÆ°u biá»ƒu Ä‘á»“ tá»•ng há»£p:", output_file, "\n\n")
  
  return(combined)
}

# ============================================================================
# 1. KIá»‚M TRA TÃNH TUYáº¾N TÃNH
# ============================================================================

check_linearity <- function(data, x_var, y_var, model, save_plots, output_dir) {
  cat("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n")
  cat("1ï¸âƒ£  KIá»‚M TRA TÃNH TUYáº¾N TÃNH (Linearity)\n")
  cat("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n")
  
  # Váº½ biá»ƒu Ä‘á»“ phÃ¢n tÃ¡n vá»›i Ä‘Æ°á»ng há»“i quy
  p <- ggplot(data, aes(x = !!sym(x_var), y = !!sym(y_var))) +
    geom_point(alpha = 0.6, size = 2, color = "steelblue") +
    geom_smooth(method = "lm", se = TRUE, color = "red", size = 1) +
    labs(title = paste("Biá»ƒu Ä‘á»“ phÃ¢n tÃ¡n:", y_var, "vs", x_var),
         subtitle = paste("RÂ² =", round(summary(model)$r.squared, 4)),
         x = x_var,
         y = y_var) +
    theme_minimal() +
    theme(plot.title = element_text(hjust = 0.5, face = "bold", size = 12),
          plot.subtitle = element_text(hjust = 0.5, size = 10))
  
  if (save_plots) {
    ggsave(file.path(output_dir, paste0("linearity_", y_var, "_", x_var, ".png")),
           p, width = 8, height = 6, dpi = 300)
  }
  
  # ÄÃ¡nh giÃ¡ tÃ­nh tuyáº¿n tÃ­nh
  r_squared <- summary(model)$r.squared
  p_value <- summary(model)$coefficients[2, 4]
  
  cat("ğŸ“Š ÄÃ¡nh giÃ¡:\n")
  cat(sprintf("   RÂ² = %.4f\n", r_squared))
  cat(sprintf("   p-value = %.4e\n", p_value))
  
  # Káº¿t luáº­n
  is_linear <- FALSE
  if (p_value < 0.05) {
    if (r_squared > 0.7) {
      cat("\nâœ… Káº¾T LUáº¬N: Má»‘i quan há»‡ TUYáº¾N TÃNH Máº NH\n")
      cat("   â†’ MÃ´ hÃ¬nh phÃ¹ há»£p tá»‘t vá»›i dá»¯ liá»‡u\n\n")
      is_linear <- TRUE
    } else if (r_squared > 0.4) {
      cat("\nâš ï¸  Káº¾T LUáº¬N: Má»‘i quan há»‡ TUYáº¾N TÃNH Vá»ªA PHáº¢I\n")
      cat("   â†’ MÃ´ hÃ¬nh cÃ³ thá»ƒ sá»­ dá»¥ng nhÆ°ng cáº§n tháº­n trá»ng\n\n")
      is_linear <- TRUE
    } else {
      cat("\nâš ï¸  Káº¾T LUáº¬N: Má»‘i quan há»‡ TUYáº¾N TÃNH Yáº¾U\n")
      cat("   â†’ CÃ³ má»‘i quan há»‡ nhÆ°ng RÂ² tháº¥p\n")
      cat("   â†’ CÃ¢n nháº¯c thÃªm biáº¿n hoáº·c dÃ¹ng mÃ´ hÃ¬nh phi tuyáº¿n\n\n")
    }
  } else {
    cat("\nâŒ Káº¾T LUáº¬N: KHÃ”NG CÃ“ Má»I QUAN Há»† TUYáº¾N TÃNH\n")
    cat("   â†’ MÃ´ hÃ¬nh Há»’I QUY Bá»Š VI PHáº M giáº£ Ä‘á»‹nh tuyáº¿n tÃ­nh\n")
    cat("   â†’ KhÃ´ng nÃªn sá»­ dá»¥ng mÃ´ hÃ¬nh tuyáº¿n tÃ­nh nÃ y\n\n")
  }
  
  list(
    pass = is_linear,
    r_squared = r_squared,
    p_value = p_value,
    plot = p
  )
}

# ============================================================================
# 2. KIá»‚M TRA Äá»˜C Láº¬P PHáº¦N DÆ¯ (Durbin-Watson)
# ============================================================================

check_independence <- function(model) {
  cat("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n")
  cat("2ï¸âƒ£  KIá»‚M TRA Äá»˜C Láº¬P PHáº¦N DÆ¯ (Independence)\n")
  cat("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n")
  
  # Durbin-Watson test
  dw_test <- dwtest(model)
  
  cat("ğŸ“Š Kiá»ƒm Ä‘á»‹nh Durbin-Watson:\n")
  cat(sprintf("   DW statistic = %.4f\n", dw_test$statistic))
  cat(sprintf("   p-value = %.4f\n", dw_test$p.value))
  
  # ÄÃ¡nh giÃ¡
  dw_value <- as.numeric(dw_test$statistic)
  is_independent <- FALSE
  
  cat("\nğŸ“‹ Giáº£i thÃ­ch:\n")
  cat("   â€¢ DW â‰ˆ 2: Pháº§n dÆ° Ä‘á»™c láº­p (tá»‘t)\n")
  cat("   â€¢ DW < 1.5: TÆ°Æ¡ng quan dÆ°Æ¡ng (vi pháº¡m)\n")
  cat("   â€¢ DW > 2.5: TÆ°Æ¡ng quan Ã¢m (vi pháº¡m)\n\n")
  
  if (dw_value >= 1.5 && dw_value <= 2.5 && dw_test$p.value > 0.05) {
    cat("âœ… Káº¾T LUáº¬N: PHáº¦N DÆ¯ Äá»˜C Láº¬P\n")
    cat("   â†’ Giáº£ Ä‘á»‹nh Ä‘á»™c láº­p ÄÆ¯á»¢C THá»A MÃƒN\n")
    cat("   â†’ MÃ´ hÃ¬nh phÃ¹ há»£p\n\n")
    is_independent <- TRUE
  } else if (dw_value < 1.5) {
    cat("âŒ Káº¾T LUáº¬N: PHáº¦N DÆ¯ CÃ“ TÆ¯Æ NG QUAN DÆ¯Æ NG\n")
    cat("   â†’ MÃ´ hÃ¬nh Bá»Š VI PHáº M giáº£ Ä‘á»‹nh Ä‘á»™c láº­p\n")
    cat("   â†’ Gá»£i Ã½: Kiá»ƒm tra dá»¯ liá»‡u chuá»—i thá»i gian hoáº·c thÃªm biáº¿n\n\n")
  } else if (dw_value > 2.5) {
    cat("âŒ Káº¾T LUáº¬N: PHáº¦N DÆ¯ CÃ“ TÆ¯Æ NG QUAN Ã‚M\n")
    cat("   â†’ MÃ´ hÃ¬nh Bá»Š VI PHáº M giáº£ Ä‘á»‹nh Ä‘á»™c láº­p\n")
    cat("   â†’ Gá»£i Ã½: Kiá»ƒm tra láº¡i dá»¯ liá»‡u\n\n")
  } else {
    cat("âš ï¸  Káº¾T LUáº¬N: PHáº¦N DÆ¯ CÃ“ THá»‚ KHÃ”NG Äá»˜C Láº¬P\n")
    cat("   â†’ Cáº§n xem xÃ©t thÃªm\n\n")
  }
  
  list(
    pass = is_independent,
    dw_statistic = dw_value,
    p_value = dw_test$p.value
  )
}

# ============================================================================
# 3. KIá»‚M TRA PHÆ¯Æ NG SAI Äá»’NG NHáº¤T
# ============================================================================

check_homoscedasticity <- function(model, x_var, y_var, save_plots, output_dir) {
  cat("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n")
  cat("3ï¸âƒ£  KIá»‚M TRA PHÆ¯Æ NG SAI Äá»’NG NHáº¤T (Homoscedasticity)\n")
  cat("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n")
  
  # Láº¥y giÃ¡ trá»‹ dá»± Ä‘oÃ¡n vÃ  pháº§n dÆ°
  fitted_values <- fitted(model)
  residuals <- residuals(model)
  
  # Váº½ biá»ƒu Ä‘á»“ pháº§n dÆ° vs giÃ¡ trá»‹ dá»± Ä‘oÃ¡n
  plot_data <- data.frame(Fitted = fitted_values, Residuals = residuals)
  
  p <- ggplot(plot_data, aes(x = Fitted, y = Residuals)) +
    geom_point(alpha = 0.6, size = 2, color = "steelblue") +
    geom_hline(yintercept = 0, linetype = "dashed", color = "red", size = 1) +
    geom_smooth(method = "loess", se = FALSE, color = "orange", size = 0.8) +
    labs(title = "Kiá»ƒm tra phÆ°Æ¡ng sai Ä‘á»“ng nháº¥t",
         subtitle = "Pháº§n dÆ° nÃªn phÃ¢n tÃ¡n Ä‘á»u quanh Ä‘Æ°á»ng 0",
         x = "GiÃ¡ trá»‹ dá»± Ä‘oÃ¡n",
         y = "Pháº§n dÆ°") +
    theme_minimal() +
    theme(plot.title = element_text(hjust = 0.5, face = "bold", size = 12),
          plot.subtitle = element_text(hjust = 0.5, size = 9))
  
  if (save_plots) {
    ggsave(file.path(output_dir, 
                     paste0("homoscedasticity_", y_var, "_", x_var, ".png")),
           p, width = 8, height = 6, dpi = 300)
  }
  
  # Breusch-Pagan test
  bp_test <- tryCatch(
    bptest(model),
    error = function(e) NULL
  )
  
  if (!is.null(bp_test)) {
    cat("ğŸ“Š Kiá»ƒm Ä‘á»‹nh Breusch-Pagan:\n")
    cat(sprintf("   BP statistic = %.4f\n", bp_test$statistic))
    cat(sprintf("   p-value = %.4f\n\n", bp_test$p.value))
  }
  
  # ÄÃ¡nh giÃ¡ trá»±c quan
  residual_range <- max(abs(residuals))
  is_homoscedastic <- FALSE
  
  cat("ğŸ“‹ ÄÃ¡nh giÃ¡ trá»±c quan:\n")
  cat("   â€¢ CÃ¡c Ä‘iá»ƒm nÃªn phÃ¢n tÃ¡n Ä‘á»u quanh Ä‘Æ°á»ng 0\n")
  cat("   â€¢ KHÃ”NG cÃ³ hÃ¬nh dáº¡ng 'cÃ¡i loa' (funnel)\n")
  cat("   â€¢ KHÃ”NG cÃ³ xu hÆ°á»›ng tÄƒng/giáº£m rÃµ rÃ ng\n\n")
  
  if (!is.null(bp_test) && bp_test$p.value > 0.05) {
    cat("âœ… Káº¾T LUáº¬N: PHÆ¯Æ NG SAI Äá»’NG NHáº¤T\n")
    cat("   â†’ Giáº£ Ä‘á»‹nh ÄÆ¯á»¢C THá»A MÃƒN\n")
    cat("   â†’ MÃ´ hÃ¬nh phÃ¹ há»£p\n\n")
    is_homoscedastic <- TRUE
  } else if (!is.null(bp_test) && bp_test$p.value <= 0.05) {
    cat("âŒ Káº¾T LUáº¬N: PHÆ¯Æ NG SAI KHÃ”NG Äá»’NG NHáº¤T\n")
    cat("   â†’ MÃ´ hÃ¬nh Bá»Š VI PHáº M giáº£ Ä‘á»‹nh nÃ y\n")
    cat("   â†’ Gá»£i Ã½: Biáº¿n Ä‘á»•i dá»¯ liá»‡u (log, sqrt) hoáº·c dÃ¹ng WLS\n\n")
  } else {
    cat("âš ï¸  Káº¾T LUáº¬N: KHÃ”NG THá»‚ KIá»‚M Äá»ŠNH\n")
    cat("   â†’ Xem xÃ©t biá»ƒu Ä‘á»“ Ä‘á»ƒ Ä‘Ã¡nh giÃ¡\n\n")
    is_homoscedastic <- TRUE  # Giáº£ Ä‘á»‹nh Ä‘áº¡t náº¿u khÃ´ng test Ä‘Æ°á»£c
  }
  
  list(
    pass = is_homoscedastic,
    bp_statistic = if (!is.null(bp_test)) bp_test$statistic else NA,
    p_value = if (!is.null(bp_test)) bp_test$p.value else NA,
    plot = p
  )
}

# ============================================================================
# 4. KIá»‚M TRA PHÃ‚N PHá»I CHUáº¨N PHáº¦N DÆ¯
# ============================================================================

check_residual_normality <- function(model, x_var, y_var, save_plots, output_dir) {
  cat("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n")
  cat("4ï¸âƒ£  KIá»‚M TRA PHÃ‚N PHá»I CHUáº¨N PHáº¦N DÆ¯ (Normality)\n")
  cat("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n")
  
  residuals <- residuals(model)
  
  # Táº¡o Q-Q plot
  p <- ggplot(data.frame(residuals = residuals), aes(sample = residuals)) +
    stat_qq(alpha = 0.6, size = 2, color = "steelblue") +
    stat_qq_line(color = "red", size = 1) +
    labs(title = "Q-Q Plot: Kiá»ƒm tra phÃ¢n phá»‘i chuáº©n pháº§n dÆ°",
         subtitle = "CÃ¡c Ä‘iá»ƒm nÃªn náº±m gáº§n Ä‘Æ°á»ng chÃ©o",
         x = "Quantile lÃ½ thuyáº¿t",
         y = "Quantile máº«u") +
    theme_minimal() +
    theme(plot.title = element_text(hjust = 0.5, face = "bold", size = 12),
          plot.subtitle = element_text(hjust = 0.5, size = 9))
  
  if (save_plots) {
    ggsave(file.path(output_dir, 
                     paste0("normality_", y_var, "_", x_var, ".png")),
           p, width = 8, height = 6, dpi = 300)
  }
  
  # Shapiro-Wilk test
  shapiro_test <- tryCatch(
    shapiro.test(residuals),
    error = function(e) NULL
  )
  
  if (!is.null(shapiro_test)) {
    cat("ğŸ“Š Kiá»ƒm Ä‘á»‹nh Shapiro-Wilk:\n")
    cat(sprintf("   W statistic = %.4f\n", shapiro_test$statistic))
    cat(sprintf("   p-value = %.4f\n\n", shapiro_test$p.value))
  }
  
  # ÄÃ¡nh giÃ¡
  is_normal <- FALSE
  
  cat("ğŸ“‹ ÄÃ¡nh giÃ¡:\n")
  cat("   â€¢ CÃ¡c Ä‘iá»ƒm trÃªn Q-Q plot nÃªn náº±m gáº§n Ä‘Æ°á»ng chÃ©o\n")
  cat("   â€¢ p-value > 0.05 â†’ PhÃ¢n phá»‘i chuáº©n\n\n")
  
  if (!is.null(shapiro_test) && shapiro_test$p.value > 0.05) {
    cat("âœ… Káº¾T LUáº¬N: PHáº¦N DÆ¯ PHÃ‚N PHá»I CHUáº¨N\n")
    cat("   â†’ Giáº£ Ä‘á»‹nh ÄÆ¯á»¢C THá»A MÃƒN\n")
    cat("   â†’ MÃ´ hÃ¬nh phÃ¹ há»£p\n\n")
    is_normal <- TRUE
  } else if (!is.null(shapiro_test) && shapiro_test$p.value <= 0.05) {
    cat("âŒ Káº¾T LUáº¬N: PHáº¦N DÆ¯ KHÃ”NG PHÃ‚N PHá»I CHUáº¨N\n")
    cat("   â†’ MÃ´ hÃ¬nh Bá»Š VI PHáº M giáº£ Ä‘á»‹nh nÃ y\n")
    cat("   â†’ Gá»£i Ã½: Biáº¿n Ä‘á»•i biáº¿n phá»¥ thuá»™c (log, sqrt) hoáº·c loáº¡i outliers\n\n")
  } else {
    cat("âš ï¸  Káº¾T LUáº¬N: KHÃ”NG THá»‚ KIá»‚M Äá»ŠNH\n")
    cat("   â†’ Xem xÃ©t Q-Q plot Ä‘á»ƒ Ä‘Ã¡nh giÃ¡\n\n")
    is_normal <- TRUE  # Giáº£ Ä‘á»‹nh Ä‘áº¡t náº¿u khÃ´ng test Ä‘Æ°á»£c
  }
  
  list(
    pass = is_normal,
    w_statistic = if (!is.null(shapiro_test)) shapiro_test$statistic else NA,
    p_value = if (!is.null(shapiro_test)) shapiro_test$p.value else NA,
    plot = p
  )
}

# ============================================================================
# Káº¾T LUáº¬N Tá»”NG THá»‚
# ============================================================================

overall_conclusion <- function(results) {
  cat("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n")
  cat("ğŸ“‹ Káº¾T LUáº¬N Tá»”NG THá»‚\n")
  cat("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n")
  
  assumptions <- c(
    "Tuyáº¿n tÃ­nh" = results$linearity$pass,
    "Äá»™c láº­p pháº§n dÆ°" = results$independence$pass,
    "PhÆ°Æ¡ng sai Ä‘á»“ng nháº¥t" = results$homoscedasticity$pass,
    "PhÃ¢n phá»‘i chuáº©n" = results$normality$pass
  )
  
  cat("âœ“/âœ— TÃ³m táº¯t giáº£ Ä‘á»‹nh:\n")
  for (i in seq_along(assumptions)) {
    status <- ifelse(assumptions[i], "âœ… Äáº¡t", "âŒ Vi pháº¡m")
    cat(sprintf("   %d. %-20s: %s\n", i, names(assumptions)[i], status))
  }
  
  cat("\n")
  
  # Káº¿t luáº­n cuá»‘i cÃ¹ng
  all_pass <- all(assumptions)
  
  if (all_pass) {
    cat("ğŸ‰ Káº¾T LUáº¬N: MÃ” HÃŒNH PHÃ™ Há»¢P\n")
    cat("   â†’ Táº¥t cáº£ giáº£ Ä‘á»‹nh Äá»€U ÄÆ¯á»¢C THá»A MÃƒN\n")
    cat("   â†’ CÃ“ THá»‚ Sá»¬ Dá»¤NG mÃ´ hÃ¬nh há»“i quy tuyáº¿n tÃ­nh nÃ y\n")
    cat("   â†’ Káº¿t quáº£ dá»± Ä‘oÃ¡n Ä‘Ã¡ng tin cáº­y\n\n")
  } else {
    violated <- names(assumptions)[!assumptions]
    cat("âš ï¸  Káº¾T LUáº¬N: MÃ” HÃŒNH Bá»Š VI PHáº M\n")
    cat(sprintf("   â†’ Vi pháº¡m: %s\n", paste(violated, collapse = ", ")))
    cat("   â†’ KHÃ”NG NÃŠN Sá»¬ Dá»¤NG mÃ´ hÃ¬nh nÃ y\n")
    cat("   â†’ Cáº§n kháº¯c phá»¥c vi pháº¡m trÆ°á»›c khi sá»­ dá»¥ng\n\n")
  }
  
  list(
    all_assumptions_met = all_pass,
    violated = names(assumptions)[!assumptions]
  )
}

# ============================================================================
# BÃO CÃO Tá»”NG Káº¾T
# ============================================================================

print_overall_report <- function(all_results) {
  cat("\n\nâ•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—\n")
  cat("â•‘              BÃO CÃO Tá»”NG Káº¾T Táº¤T Cáº¢ MÃ” HÃŒNH          â•‘\n")
  cat("â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n")
  
  if (length(all_results) == 0) {
    cat("KhÃ´ng cÃ³ mÃ´ hÃ¬nh nÃ o Ä‘Æ°á»£c phÃ¢n tÃ­ch\n")
    return()
  }
  
  # Táº¡o báº£ng tÃ³m táº¯t
  summary_df <- data.frame()
  
  for (model_name in names(all_results)) {
    result <- all_results[[model_name]]
    
    summary_df <- rbind(summary_df, data.frame(
      Model = paste(result$dep_var, "~", result$indep_var),
      N = result$n,
      R2 = sprintf("%.3f", result$r_squared),
      Linearity = ifelse(result$linearity$pass, "âœ“", "âœ—"),
      Independence = ifelse(result$independence$pass, "âœ“", "âœ—"),
      Homoscedasticity = ifelse(result$homoscedasticity$pass, "âœ“", "âœ—"),
      Normality = ifelse(result$normality$pass, "âœ“", "âœ—"),
      Overall = ifelse(result$overall$all_assumptions_met, "âœ… OK", "âŒ Vi pháº¡m")
    ))
  }
  
  print(summary_df, row.names = FALSE)
  
  # Thá»‘ng kÃª tá»•ng quÃ¡t
  total_models <- nrow(summary_df)
  valid_models <- sum(summary_df$Overall == "âœ… OK")
  
  cat("\nğŸ“Š THá»NG KÃŠ:\n")
  cat(sprintf("   Tá»•ng sá»‘ mÃ´ hÃ¬nh: %d\n", total_models))
  cat(sprintf("   MÃ´ hÃ¬nh há»£p lá»‡: %d (%.1f%%)\n", 
              valid_models, valid_models/total_models*100))
  cat(sprintf("   MÃ´ hÃ¬nh vi pháº¡m: %d (%.1f%%)\n\n", 
              total_models - valid_models, 
              (total_models - valid_models)/total_models*100))
}


#CÃº phÃ¡p thá»±c hiá»‡n phÃ¢n tÃ­ch data

results <- check_regression_assumptions(
  data = data1,
  independent_vars = c("CC","Tua"),
  dependent_vars = "Conc"
)

#Check cÃ¡c mÃ´ hÃ¬nh cÃ³
results$list_models()

#check mÃ´ hÃ¬nh tuyáº¿n tÃ­nh
results$show_plot('Conc_vs_CC', 'linearity')

# Hiá»ƒn thá»‹ biá»ƒu Ä‘á»“ phÆ°Æ¡ng sai
results$show_plot('Conc_vs_CC', 'homoscedasticity')

 # Hiá»ƒn thá»‹ Q-Q plot
results$show_plot('Conc_vs_Tua', 'normality')
